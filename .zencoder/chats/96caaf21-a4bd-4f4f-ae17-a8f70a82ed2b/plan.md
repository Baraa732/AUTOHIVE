# Feature development workflow

---

## Workflow Steps

### [x] Step: Requirements

Your job is to generate a Product Requirements Document based on the feature description,

First, analyze the provided feature definition and determine unclear aspects. For unclear aspects: - Make informed guesses based on context and industry standards - Only mark with [NEEDS CLARIFICATION: specific question] if: - The choice significantly impacts feature scope or user experience - Multiple reasonable interpretations exist with different implications - No reasonable default exists - Prioritize clarifications by impact: scope > security/privacy > user experience > technical details

Ask up to 5 most priority clarifications to the user. Then, create the document following this template:

```
# Feature Specification: [FEATURE NAME]


## User Stories*


### User Story 1 - [Brief Title]

**Acceptance Scenarios**:

1. **Given** [initial state], **When** [action], **Then** [expected outcome]
2. **Given** [initial state], **When** [action], **Then** [expected outcome]

---

## Requirements*

## Success Criteria*

```

Save the PRD into `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\96caaf21-a4bd-4f4f-ae17-a8f70a82ed2b/requirements.md`.

### [x] Step: Technical Specification

Based on the PRD in `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\96caaf21-a4bd-4f4f-ae17-a8f70a82ed2b/requirements.md`, create a detailed technical specification to be used by a coding agent to implement the feature. Follow this template:

```
# Technical Specification: [FEATURE]

## Technical Context
Language/Version, primary dependencies, etc

## Technical Implementation Brief

Summarize key technical decisions for implementing the feature. Make sure they take into account the existing code as much as possible.

## Source Code Structure

## Contracts

Define addition or changes in data models, DB schemas, APIs, code interfaces etc

## Delivery Phases

Define several incremental deliverables for the feature. Each should be a minimal viable product testable end-to-end.

## Verification Strategy

Define how the coding agent can verify each deliverable it creates. Provide instructions for the agent to perform the verification using available tools (lint/test commands, bash commands) and create helper scripts and tools for more complex result verification.
The verification for each deliverable should be executable by a coding agent using built-in capabilities (lint and test commands from the project, bash commands), pre-generated helper scripts or MCP servers. Research and add to the spec:

- MCP servers that should be installed to help the agent with the verification

- helper scripts that need to be generated in the first phases of the plan to verify complex scenarios that can't be covered by the tests in the project's test framework(s)

- any sample input artifact(s) that are required for verification. Note if these artifacts can be a) generated by the agent; b) discovered by the agent on line; c) must be provided by the user.
```

Save the spec to `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\96caaf21-a4bd-4f4f-ae17-a8f70a82ed2b/spec.md`.

### [x] Step: Implementation Plan

---

## PHASE 1: Backend Foundation

### [ ] Step: Create database migrations for rental application modifications
Create migrations to extend rental_applications table and create rental_application_modifications table.

**References**: spec.md - Contracts/Data Model Contracts section
**Files to Create**:
- `database/migrations/YYYY_MM_DD_HHMMSS_add_modification_fields_to_rental_applications_table.php`
- `database/migrations/YYYY_MM_DD_HHMMSS_create_rental_application_modifications_table.php`
- `database/migrations/YYYY_MM_DD_HHMMSS_add_rental_status_to_users_table.php`

**Deliverable**: Three migration files that can be run with `php artisan migrate`
**Verification**: 
```bash
php artisan migrate
php artisan migrate:rollback
php artisan migrate
# Verify tables exist with correct columns
sqlite> .schema rental_applications
sqlite> .schema rental_application_modifications
sqlite> .schema users
```

### [ ] Step: Extend RentalApplication and User models
Update existing models to support modification workflow and rental status tracking.

**References**: spec.md - Contracts/Data Model Contracts, Source Code Structure
**Files to Modify**:
- `app/Models/RentalApplication.php` - Add relationships, helper methods, statuses
- `app/Models/User.php` - Add rental_status and rental_end_date fields to fillable

**Deliverable**: Updated model classes with:
- New enum status values in RentalApplication
- Relationships to RentalApplicationModification
- Helper methods: `canBeModified()`, `getDiffWithPrevious()`
- User model accepts rental_status and rental_end_date

**Verification**:
```bash
php artisan tinker
# Test model relationships
$app = RentalApplication::find(1);
$app->modifications()->count()
# Test helper methods
$app->canBeModified() // should return boolean
```

### [ ] Step: Create RentalApplicationModification model and migrations
Create new model for tracking modification history.

**References**: spec.md - Contracts, Source Code Structure
**Files to Create**:
- `app/Models/RentalApplicationModification.php`

**Deliverable**: Model with relationships to RentalApplication, proper casts, status constants
**Verification**:
```bash
php artisan tinker
$mod = RentalApplicationModification::first();
$mod->rental_application // verify relationship works
```

### [ ] Step: Create RentalApplicationService
Implement business logic for modification workflow.

**References**: spec.md - Technical Implementation Brief, Delivery Phases/Phase 1
**Files to Create**:
- `app/Services/RentalApplicationService.php`

**Methods to Implement**:
- `submitModification($applicationId, $newData, $reason)`
- `getModificationDiff($applicationId, $modificationId)`
- `approveModification($applicationId, $modificationId)`
- `rejectModification($applicationId, $modificationId, $reason)`

**Deliverable**: Service class with complete modification logic including validation
**Verification**:
```bash
php artisan tinker
$service = app(RentalApplicationService::class);
$service->submitModification(1, ['check_in' => '2025-02-01'], 'Need earlier check-in')
# Should return modification ID if successful
```

### [ ] Step: Update RentalApplicationController approve/reject methods
Modify existing endpoints to handle both original and modified states.

**References**: spec.md - API Contracts, Technical Implementation Brief
**Files to Modify**:
- `app/Http/Controllers/Api/RentalApplicationController.php` - approve() method
- Add validation to handle 'modified-pending' status
- Ensure single approval applies to entire application

**Deliverable**: Updated approve/reject methods that work with modification workflow
**Verification**: Run approval flow manually and verify Booking is created correctly

---

## PHASE 2: API Endpoints

### [ ] Step: Implement POST /rental-applications/{id}/modify endpoint
Create endpoint for tenant to submit modifications.

**References**: spec.md - API Contracts/Modify Rental Application
**Files to Modify**:
- `app/Http/Controllers/Api/RentalApplicationController.php` - Add modify() method
- `routes/api.php` - Add new route

**Endpoint**: `POST /rental-applications/{id}/modify`
**Validation Rules**:
- check_in: required|date|after_or_equal:today
- check_out: required|date|after:check_in
- message: nullable|string|max:1000
- Can only modify if status is 'pending' OR 'approved'

**Deliverable**: Working endpoint that creates modification record
**Verification**:
```bash
# Using Postman or curl
POST /rental-applications/1/modify
Authorization: Bearer {token}
Content-Type: application/json
{
  "check_in": "2025-02-15",
  "check_out": "2025-02-28",
  "message": "Can I extend?"
}
# Should return status: "modified-pending"
```

### [ ] Step: Implement GET /rental-applications/{id}/modifications endpoint
Create endpoint to retrieve modification history with diffs.

**References**: spec.md - API Contracts/Get Modification History
**Files to Modify**:
- `app/Http/Controllers/Api/RentalApplicationController.php` - Add getModifications() method
- `routes/api.php` - Add new route

**Endpoint**: `GET /rental-applications/{id}/modifications`
**Features**:
- Return all modifications in chronological order
- Include diff between previous_values and new_values
- Include status of each modification (pending/approved/rejected)

**Deliverable**: Endpoint returning modification history with diffs
**Verification**:
```bash
GET /rental-applications/1/modifications
# Should return array of modifications with previous/new values
```

### [ ] Step: Implement modification approve/reject endpoints
Create endpoints for landlord to review and approve/reject modifications.

**References**: spec.md - API Contracts/Approve Reject Modification
**Files to Modify**:
- `app/Http/Controllers/Api/RentalApplicationController.php` - Add approveModification(), rejectModification()
- `routes/api.php` - Add new routes

**Endpoints**:
- `POST /rental-applications/{id}/modifications/{modId}/approve`
- `POST /rental-applications/{id}/modifications/{modId}/reject`

**Reject Endpoint**:
- Accepts optional rejection_reason
- Reverts application to previous status with old data
- Creates notification for tenant

**Deliverable**: Both endpoints functional with proper validation
**Verification**:
```bash
# Approve modification
POST /rental-applications/1/modifications/1/approve
# Should update application status to approved and create Booking

# Reject modification
POST /rental-applications/1/modifications/1/reject
Body: { "rejection_reason": "..." }
# Should revert to previous status and data
```

### [ ] Step: Add modification events and notifications
Create events and listeners for modification workflow.

**References**: spec.md - Notification System
**Files to Create**:
- `app/Events/RentalApplicationModified.php`
- `app/Listeners/SendModificationNotification.php`

**Deliverable**: Events triggered on modification, approval, rejection
**Verification**:
```bash
php artisan tinker
# Trigger modification event manually and verify notification created
event(new RentalApplicationModified($application, $modification));
# Check Notification::latest()->first()
```

---

## PHASE 3: Tenant UI

### [ ] Step: Update RentalApplication model in Flutter
Enhance Flutter data model to support modifications.

**References**: spec.md - Frontend Data Model Changes
**Files to Modify**:
- `client/lib/data/models/rental_application.dart`

**Changes**:
- Add previousStatus, previousData, currentData, modificationSubmittedAt fields
- Add helper method: `canBeModified()` - returns true if pending or approved
- Update fromJson/toJson to handle new fields

**Deliverable**: Updated model that Flutter can serialize/deserialize
**Verification**:
```bash
flutter pub get
# Build should succeed without errors
flutter build
```

### [ ] Step: Create modify_application_form.dart screen
Build UI for tenant to submit modifications.

**References**: spec.md - Source Code Structure, Delivery Phases/Phase 3
**Files to Create**:
- `client/lib/presentation/screens/tenant/modify_application_form.dart`

**Features**:
- Shows current values read-only
- Form fields for check_in, check_out, optional message
- Validates dates
- Submit button

**Deliverable**: Screen that navigates from rental applications list
**Verification**:
```bash
flutter run
# Navigate to rental application, tap modify
# Fill form and submit
# Verify status changes to "modified-pending"
```

### [ ] Step: Add modification API methods to ApiService
Add Flutter HTTP methods for modification endpoints.

**References**: spec.md - API Contracts
**Files to Modify**:
- `client/lib/core/network/api_service.dart`

**Methods to Add**:
- `modifyRentalApplication(id, checkIn, checkOut, message)`
- `getModificationHistory(applicationId)`
- `approveModification(applicationId, modificationId)`
- `rejectModification(applicationId, modificationId, reason)`

**Deliverable**: Methods callable from UI widgets
**Verification**: Methods should use existing HTTP client patterns

### [ ] Step: Update rental_applications_list.dart to show modification status
Enhance list view to display modification status badges.

**References**: spec.md - Source Code Structure
**Files to Modify**:
- `client/lib/presentation/screens/tenant/rental_applications_list.dart`

**Changes**:
- Show "modified-pending" status with different badge color
- Show last modified date
- Show modify button only if eligible
- Add modification history link

**Deliverable**: List screen showing modification statuses
**Verification**:
```bash
flutter run
# After modifying an application, verify status shows "Modified - Pending Review"
```

---

## PHASE 4: Landlord UI + Diff View

### [ ] Step: Create diff_view_widget.dart reusable component
Build reusable widget to display before/after values.

**References**: spec.md - Source Code Structure
**Files to Create**:
- `client/lib/presentation/widgets/diff_view_widget.dart`

**Features**:
- Display field name, old value (strikethrough/red), new value (green)
- Handle different data types (dates, strings, numbers)
- Optional highlighted changed fields

**Deliverable**: Reusable widget that works with any modification data
**Verification**:
```bash
flutter run
# Should display in modification review screen
```

### [ ] Step: Create modification_review_screen.dart
Build landlord screen to review modifications with diff view.

**References**: spec.md - Source Code Structure, Delivery Phases/Phase 4
**Files to Create**:
- `client/lib/presentation/screens/landlord/modification_review_screen.dart`

**Features**:
- Display application details (unchanged)
- Show diff view of changes
- Approve button (green)
- Reject button with reason dialog (red)
- Show modification history in expandable section

**Deliverable**: Screen accessible from application detail
**Verification**:
```bash
flutter run
# Navigate to incoming application with modifications
# Verify diff view shows before/after values clearly
# Test approve/reject buttons
```

### [ ] Step: Update incoming_rental_applications.dart to show modified status
Enhance landlord list to show which applications have pending modifications.

**References**: spec.md - Source Code Structure
**Files to Modify**:
- `client/lib/presentation/screens/landlord/incoming_rental_applications.dart`

**Changes**:
- Show badge for "modified-pending" status
- Navigate to modification_review_screen for modified apps
- Show last modification date

**Deliverable**: List clearly indicates which apps have pending modifications
**Verification**:
```bash
flutter run
# Verify modified applications show distinct status
```

### [ ] Step: Update rental_application_detail.dart to show modification history
Enhance detail screen to display modification history.

**References**: spec.md - Source Code Structure
**Files to Modify**:
- `client/lib/presentation/screens/landlord/rental_application_detail.dart`

**Changes**:
- If modified-pending: Navigate to modification_review_screen
- If has history: Add expandable section showing all modifications
- Show diff for each modification

**Deliverable**: Detail screen showing full modification history with diffs
**Verification**:
```bash
flutter run
# Open application with modifications
# Verify history shows all modifications with diffs
```

---

## PHASE 5: Auto-Transition System

### [ ] Step: Create RentalStatusTransitionService
Implement business logic for automatic status transitions.

**References**: spec.md - Auto-Transition System
**Files to Create**:
- `app/Services/RentalStatusTransitionService.php`

**Methods**:
- `transitionExpiredRentals()` - Main scheduler method
- `markUserAsInactive($userId)` - Single user transition

**Deliverable**: Service that checks rental_end_date and updates rental_status
**Verification**:
```bash
php artisan tinker
$service = app(RentalStatusTransitionService::class);
$service->transitionExpiredRentals();
# Should update users with rental_end_date <= today
```

### [ ] Step: Create TransitionRentalStatusJob
Create Laravel job for scheduler.

**References**: spec.md - Auto-Transition System
**Files to Create**:
- `app/Jobs/TransitionRentalStatusJob.php`

**Deliverable**: Queueable job
**Verification**:
```bash
php artisan make:job TransitionRentalStatusJob
# Job should dispatch and complete without errors
```

### [ ] Step: Register job in Laravel Console Kernel
Configure scheduler to run daily.

**References**: spec.md - Auto-Transition System
**Files to Modify**:
- `app/Console/Kernel.php`

**Changes**:
- Add schedule for TransitionRentalStatusJob to run daily at midnight
- Example: `$schedule->job(new TransitionRentalStatusJob)->daily();`

**Deliverable**: Job scheduled to run automatically
**Verification**:
```bash
php artisan schedule:work
# Should run job at scheduled time
# Check Logs for execution
```

### [ ] Step: Add notifications for auto-transition
Create notification for users when rental status changes.

**References**: spec.md - Notification System
**Files to Modify**:
- Update RentalStatusTransitionService to create notifications
- Create notification model if not exists

**Deliverable**: Users notified when rental status transitions
**Verification**:
```bash
# Manually transition user status
# Verify notification created in database
Notification::where('user_id', $userId)->latest()->first()
```

### [ ] Step: Add tests for auto-transition system
Create tests to verify scheduler works correctly.

**References**: spec.md - Verification Strategy
**Files to Create**:
- `tests/Feature/RentalStatusTransitionTest.php`

**Tests**:
- Test user with past rental_end_date transitions to inactive
- Test notification created
- Test user with future rental_end_date not affected

**Deliverable**: Tests pass
**Verification**:
```bash
php artisan test --filter RentalStatusTransition
# All tests should pass
```

---

## Final Verification

### [ ] Step: Run full test suite and lint
Ensure all changes pass quality checks.

**Commands**:
```bash
# Backend
cd server
php artisan test
php composer run test (if using composer scripts)
php artisan lint (if available)

# Frontend
cd ../client
flutter test (if tests exist)
flutter analyze
flutter build
```

**Deliverable**: All tests pass, no lint errors
**Verification**: Exit code 0 for all commands
