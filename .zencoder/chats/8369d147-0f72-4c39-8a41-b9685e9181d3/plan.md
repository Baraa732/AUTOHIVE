# Feature development workflow

---

## Workflow Steps

### [x] Step: Requirements

Your job is to generate a Product Requirements Document based on the feature description,

First, analyze the provided feature definition and determine unclear aspects. For unclear aspects: - Make informed guesses based on context and industry standards - Only mark with [NEEDS CLARIFICATION: specific question] if: - The choice significantly impacts feature scope or user experience - Multiple reasonable interpretations exist with different implications - No reasonable default exists - Prioritize clarifications by impact: scope > security/privacy > user experience > technical details

Ask up to 5 most priority clarifications to the user. Then, create the document following this template:

```
# Feature Specification: [FEATURE NAME]


## User Stories*


### User Story 1 - [Brief Title]

**Acceptance Scenarios**:

1. **Given** [initial state], **When** [action], **Then** [expected outcome]
2. **Given** [initial state], **When** [action], **Then** [expected outcome]

---

## Requirements*

## Success Criteria*

```

Save the PRD into `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\8369d147-0f72-4c39-8a41-b9685e9181d3/requirements.md`.

### [x] Step: Technical Specification

Based on the PRD in `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\8369d147-0f72-4c39-8a41-b9685e9181d3/requirements.md`, create a detailed technical specification to be used by a coding agent to implement the feature. Follow this template:

```
# Technical Specification: [FEATURE]

## Technical Context
Language/Version, primary dependencies, etc

## Technical Implementation Brief

Summarize key technical decisions for implementing the feature. Make sure they take into account the existing code as much as possible.

## Source Code Structure

## Contracts

Define addition or changes in data models, DB schemas, APIs, code interfaces etc

## Delivery Phases

Define several incremental deliverables for the feature. Each should be a minimal viable product testable end-to-end.

## Verification Strategy

Define how the coding agent can verify each deliverable it creates. Provide instructions for the agent to perform the verification using available tools (lint/test commands, bash commands) and create helper scripts and tools for more complex result verification.
The verification for each deliverable should be executable by a coding agent using built-in capabilities (lint and test commands from the project, bash commands), pre-generated helper scripts or MCP servers. Research and add to the spec:

- MCP servers that should be installed to help the agent with the verification

- helper scripts that need to be generated in the first phases of the plan to verify complex scenarios that can't be covered by the tests in the project's test framework(s)

- any sample input artifact(s) that are required for verification. Note if these artifacts can be a) generated by the agent; b) discovered by the agent on line; c) must be provided by the user.
```

Save the spec to `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\8369d147-0f72-4c39-8a41-b9685e9181d3/spec.md`.

### [x] Step: Implementation Plan

Based on the technical spec, detailed implementation tasks follow below.

---

### [x] Step: Phase 1 - Create Riverpod Providers for Rental Applications

**Task**: Establish state management layer using Riverpod to handle rental application data fetching and caching.

**References**: 
- spec.md: "Phase 1: State Management & Provider Setup"
- spec.md: "Contracts - API Endpoints"

**Implementation**:
1. Create `client/lib/data/providers/rental_applications_provider.dart` with providers:
   - `getIncomingApplicationsProvider` - StateNotifierProvider for landlord's incoming applications
   - `getMyApplicationsProvider` - StateNotifierProvider for tenant's applications
   - `applicationDetailProvider` - FutureProvider for single application
   - `modificationHistoryProvider` - FutureProvider for modifications

2. Create corresponding NotifierClasses to handle API calls and state updates

3. Update `client/lib/presentation/screens/landlord/incoming_rental_applications.dart`:
   - Replace manual API calls with provider consumption
   - Use `watch()` for reactive updates
   - Remove manual setState calls

**Deliverable**: 
- New provider file with all 4 providers
- Updated incoming_rental_applications.dart using providers
- No console errors when opening screen

**Verification**:
```bash
# 1. Run flutter analyze
flutter analyze

# 2. Run app: flutter run

# 3. Navigate to incoming applications
# 4. Verify applications load
# 5. Check debug console - no state management errors
# 6. Verify data persists when navigating away and back
```

---

### [x] Step: Phase 2 - Fix Action Buttons in Detail Screen

**Task**: Ensure approve/reject buttons are visible, functional, and properly handle user interactions with feedback.

**References**:
- spec.md: "Phase 2: Fix Action Buttons & Response Handling"
- Current file: `client/lib/presentation/screens/landlord/rental_application_detail.dart`

**Implementation**:
1. Review status validation logic in rental_application_detail.dart (lines 423-466)
2. Add debug logging to track button visibility:
   - Log application status before button rendering
   - Log whether status meets conditions for buttons to show

3. Implement proper error handling:
   - Catch and display API errors in snackbars
   - Show validation errors to user

4. Fix navigation after approval/rejection:
   - Instead of just Navigator.pop(), ensure parent list refreshes
   - Add callback mechanism to refresh parent

5. Test rejection dialog:
   - Ensure dialog shows when Reject button tapped
   - Verify reason field works
   - Confirm submission works

**Deliverable**:
- Approve button visible and functional for pending/modified-pending statuses
- Reject button visible and functional with reason dialog
- Loading indicators during processing
- Success snackbars after actions
- Automatic navigation back to list
- Parent list refreshes after action

**Verification**:
```bash
# Run app: flutter run

# Test 1: Approve button visibility and function
# 1. Navigate to incoming applications
# 2. Open an application with status 'pending'
# 3. Scroll down - verify "Approve Application" button is visible (green)
# 4. Tap it - verify loading indicator shows
# 5. Wait for success message - verify snackbar appears
# 6. Verify navigation back to list
# 7. Verify application status changed (refresh list)

# Test 2: Reject button and dialog
# 1. Repeat steps 1-2 with different pending application
# 2. Tap "Reject Application" button
# 3. Verify dialog appears with reason field
# 4. Enter rejection reason
# 5. Click "Reject" in dialog
# 6. Verify loading indicator
# 7. Verify success snackbar
# 8. Verify navigation back to list
# 9. Verify application status changed to 'rejected'

# Test 3: Buttons NOT visible when inappropriate
# 1. Open an application with status 'approved'
# 2. Scroll down - verify "Approve Application" and "Reject Application" buttons are NOT visible
# 3. Verify "Application Status" card shows "This application has been approved"
```

---

### [x] Step: Phase 3 - Create Modification Models & UI Components

**Task**: Build data model for modifications and UI components to display modification details and diffs.

**References**:
- spec.md: "Phase 3: Modification Workflow"
- spec.md: "Contracts - RentalModification Model"

**Implementation**:
1. Create `client/lib/data/models/rental_modification.dart`:
   - Implement RentalModification class with all fields
   - Add fromJson() and toJson() methods
   - Add helper methods for status checking

2. Create `client/lib/presentation/widgets/modification_diff_viewer.dart`:
   - Display modification previous vs new values
   - Highlight changed fields with visual indicators
   - Show metadata (submitted date, reason)

3. Create `client/lib/presentation/widgets/application_status_badge.dart`:
   - Color-coded status (pending=yellow, approved=green, rejected=red, modified=orange)
   - Show status text with icon
   - Add optional timestamp

4. Update `rental_application_detail.dart`:
   - Import and use modification_diff_viewer in modification-pending section
   - Show modification history
   - Add "Review Modification" button linking to review screen

**Deliverable**:
- New RentalModification model
- Diff viewer widget showing modification changes
- Status badge widget
- Updated detail screen using widgets

**Verification**:
```bash
# Run app: flutter run

# 1. Create a rental application (as tenant)
# 2. Have landlord approve it
# 3. As tenant, modify the application (change dates, etc)
# 4. As landlord, navigate to incoming applications
# 5. Open the application - should see status badge showing "modified-pending"
# 6. In detail screen, scroll down - verify "Pending Modification" card shows
# 7. Tap "Review Modification" button
# 8. Verify modification_review_screen opens
# 9. Verify diff_viewer shows old vs new values with highlights
# 10. Verify "Approve Modification" and "Reject Modification" buttons appear
```

---

### [x] Step: Phase 4 - Implement Modification Approval/Rejection

**Task**: Complete modification workflow by implementing approval and rejection of modifications in review screen.

**References**:
- spec.md: "Phase 3: Modification Workflow"
- Current file: `client/lib/presentation/screens/shared/modification_review_screen.dart`

**Implementation**:
1. Review/fix `modification_review_screen.dart`:
   - Display full modification details with diff_viewer widget
   - Show approve and reject buttons
   - Add rejection reason dialog (similar to approval screen)

2. Implement approve modification handler:
   - Call `_apiService.approveModification(appId, modId)`
   - Show loading indicator
   - Display success snackbar
   - Navigate back with success flag

3. Implement reject modification handler:
   - Call `_apiService.rejectModification(appId, modId, reason)`
   - Show rejection reason dialog
   - Display success snackbar
   - Verify application reverts to previous status
   - Navigate back with success flag

4. Add refresh mechanism:
   - Parent screens refresh when returning from modification review
   - Ensure updated status appears in lists

**Deliverable**:
- Fully functional modification_review_screen
- Approve modification working
- Reject modification working with reason dialog
- Status updates reflected in lists

**Verification**:
```bash
# Run app: flutter run

# Full modification workflow:
# 1. As tenant: Create and submit rental application
# 2. As landlord: Approve the application
# 3. As tenant: Navigate to applications, find approved one
# 4. As tenant: Tap modify button, change dates
# 5. As landlord: Check incoming - should see status "modified-pending"
# 6. As landlord: Open application, tap "Review Modification"
# 7. Verify diff shows old vs new dates
# 8. TEST A - Approve modification:
#    - Tap "Approve Modification"
#    - Verify loading shows
#    - Verify success snackbar
#    - Go back to list - status should be "modified-approved"
# 9. TEST B - Reject modification (repeat steps 1-7):
#    - Tap "Reject Modification"
#    - Enter rejection reason
#    - Confirm rejection
#    - Verify loading shows
#    - Verify success snackbar
#    - Go back to list - status should revert to "approved"
```

---

### [x] Step: Phase 5 - Create Tenant Profile Display Widget

**Task**: Build reusable widget for displaying tenant information consistently across screens.

**References**:
- spec.md: "Phase 4: Status Indicators & Status Display"

**Implementation**:
1. Create `client/lib/presentation/widgets/tenant_profile_card.dart`:
   - Display tenant name, email, phone in card format
   - Show avatar/profile picture
   - Make it reusable with parameters for layout (horizontal/vertical)
   - Add optional tap handler

2. Use in `incoming_rental_applications.dart`:
   - Replace manual tenant info section in card with widget

3. Use in `rental_application_detail.dart`:
   - Replace tenant information section with widget

**Deliverable**:
- New tenant_profile_card.dart widget
- Updated screens using the widget
- Consistent tenant display across app

**Verification**:
Visual inspection:
```bash
# 1. Run app: flutter run
# 2. Navigate to incoming applications list
# 3. Verify each application card shows tenant profile consistently
# 4. Open an application
# 5. Verify "Tenant Information" section shows profile consistently
# 6. Verify consistency between list and detail views
```

---

### [x] Step: Phase 6 - Add Status Indicators to All Screens

**Task**: Display application status badges throughout the application UI for clarity.

**References**:
- spec.md: "Phase 4: Status Indicators & Status Display"
- Widget: application_status_badge.dart (created in Phase 3)

**Implementation**:
1. Update `incoming_rental_applications.dart`:
   - Add status badge to each application card
   - Position near application title

2. Update `rental_application_detail.dart`:
   - Add status badge to header or near apartment title
   - Replace text-based status with badge

3. Update `rental_applications_list.dart` (tenant side):
   - Add status badge to each application in list

4. Ensure consistent color scheme:
   - pending = Yellow
   - approved = Green
   - rejected = Red
   - modified-pending = Orange
   - modified-approved = Light Green

**Deliverable**:
- Status badges visible in all application lists
- Status badges in detail screens
- Consistent color scheme throughout

**Verification**:
Visual inspection:
```bash
# 1. Run app: flutter run
# 2. Create multiple applications with different statuses
# 3. As landlord, view incoming applications list
# 4. Verify each application shows status badge with correct color
# 5. Open an application
# 6. Verify status badge shows in detail header
# 7. As tenant, view my applications
# 8. Verify status badges show and are accurate
# 9. Verify all 5 statuses display correctly: pending, approved, rejected, modified-pending, modified-approved
# 10. Verify colors match specification
```

---

### [x] Step: Phase 7 - End-to-End Testing & Bug Fixes

**Task**: Complete workflow testing and fix any remaining issues.

**References**:
- spec.md: "Phase 5: Integration & Bug Fixes"
- requirements.md: Success Criteria (items 1-10)

**Implementation**:
1. Manual end-to-end testing:
   - Test all user stories from requirements
   - Test edge cases (rapid clicks, network errors, back navigation during loading)
   - Test on multiple devices/screen sizes

2. Fix identified issues:
   - Handle network timeouts gracefully
   - Prevent double-submissions (disable buttons during processing)
   - Handle back navigation during loading states
   - Prevent rapid repeated taps

3. Performance optimization:
   - Verify lists scroll smoothly
   - Check memory usage during list rendering
   - Optimize image loading for tenant avatars

4. Run Flutter quality checks:
   - flutter analyze
   - flutter test (if tests exist)

**Deliverable**:
- All user stories working end-to-end
- No console errors or warnings
- Smooth UI interactions
- Proper error handling

**Verification**:
```bash
# 1. Run flutter analyze - should have 0 issues
flutter analyze

# 2. Run flutter run and test complete workflows:

# WORKFLOW 1: Full Approval
# - Open app as tenant user
# - Navigate to apartments list
# - Find available apartment, tap it
# - Fill rental application form with valid dates
# - Submit application
# - Switch to landlord user (in debug or new session)
# - Navigate to incoming applications
# - Verify application appears with status badge "pending"
# - Tap to open it
# - Verify "Approve Application" button visible
# - Tap approve button
# - Verify loading indicator
# - Verify success snackbar
# - Navigate back to list
# - Verify application status now shows "approved"
# - Switch to tenant
# - Verify application status shows "approved" in tenant's list

# WORKFLOW 2: Rejection with Reason
# - Repeat workflow 1 steps up to approve
# - Instead tap "Reject Application" button
# - Verify reject dialog appears
# - Type rejection reason in text field
# - Tap "Reject" in dialog
# - Verify loading indicator
# - Verify success snackbar
# - Navigate back to list
# - Verify application status shows "rejected"

# WORKFLOW 3: Modification and Approval
# - Repeat workflow 1 steps to get approved application
# - As tenant, navigate to applications
# - Find approved application
# - Tap "Modify" button (or use modify_application_form)
# - Change check-in/check-out dates
# - Submit modification
# - As landlord, refresh incoming applications
# - Verify application status changed to "modified-pending"
# - Tap to open
# - Verify modification pending section shows
# - Tap "Review Modification" button
# - Verify modification_review_screen opens
# - Verify diff viewer shows old vs new dates
# - Tap "Approve Modification"
# - Verify loading indicator
# - Verify success snackbar
# - Navigate back
# - Verify status shows "modified-approved"

# WORKFLOW 4: Modification and Rejection
# - Repeat workflow 3 steps up to modification_review_screen
# - Instead tap "Reject Modification" button
# - Verify rejection dialog appears
# - Type rejection reason
# - Tap "Reject"
# - Verify loading indicator
# - Verify success snackbar
# - Navigate back
# - Verify status reverted to "approved" (previous status)
# - Verify rejection reason stored

# EDGE CASES:
# 1. Rapid button clicks:
#    - Tap approve button multiple times rapidly
#    - Verify only one API call made (button disabled during processing)

# 2. Back navigation during loading:
#    - Tap approve button
#    - Immediately tap back button
#    - Verify app doesn't crash
#    - Verify state consistency

# 3. Network error handling:
#    - Turn off network
#    - Try to approve/reject
#    - Verify error message shown to user
#    - Verify button re-enabled for retry
#    - Turn network back on, retry - should succeed

# QUALITY:
# - No console errors or warnings
# - No red lines in IDE
# - Smooth animations
# - No lag when scrolling lists
# - All buttons respond immediately to taps
```
