# Feature development workflow

---

## Workflow Steps

### [x] Step: Requirements

Your job is to generate a Product Requirements Document based on the feature description,

First, analyze the provided feature definition and determine unclear aspects. For unclear aspects: - Make informed guesses based on context and industry standards - Only mark with [NEEDS CLARIFICATION: specific question] if: - The choice significantly impacts feature scope or user experience - Multiple reasonable interpretations exist with different implications - No reasonable default exists - Prioritize clarifications by impact: scope > security/privacy > user experience > technical details

Ask up to 5 most priority clarifications to the user. Then, create the document following this template:

```
# Feature Specification: [FEATURE NAME]


## User Stories*


### User Story 1 - [Brief Title]

**Acceptance Scenarios**:

1. **Given** [initial state], **When** [action], **Then** [expected outcome]
2. **Given** [initial state], **When** [action], **Then** [expected outcome]

---

## Requirements*

## Success Criteria*

```

Save the PRD into `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\4bfd128d-ecbb-4e7a-ace5-d33916834042/requirements.md`.

### [x] Step: Technical Specification

Based on the PRD in `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\4bfd128d-ecbb-4e7a-ace5-d33916834042/requirements.md`, create a detailed technical specification to be used by a coding agent to implement the feature. Follow this template:

```
# Technical Specification: [FEATURE]

## Technical Context
Language/Version, primary dependencies, etc

## Technical Implementation Brief

Summarize key technical decisions for implementing the feature. Make sure they take into account the existing code as much as possible.

## Source Code Structure

## Contracts

Define addition or changes in data models, DB schemas, APIs, code interfaces etc

## Delivery Phases

Define several incremental deliverables for the feature. Each should be a minimal viable product testable end-to-end.

## Verification Strategy

Define how the coding agent can verify each deliverable it creates. Provide instructions for the agent to perform the verification using available tools (lint/test commands, bash commands) and create helper scripts and tools for more complex result verification.
The verification for each deliverable should be executable by a coding agent using built-in capabilities (lint and test commands from the project, bash commands), pre-generated helper scripts or MCP servers. Research and add to the spec:

- MCP servers that should be installed to help the agent with the verification

- helper scripts that need to be generated in the first phases of the plan to verify complex scenarios that can't be covered by the tests in the project's test framework(s)

- any sample input artifact(s) that are required for verification. Note if these artifacts can be a) generated by the agent; b) discovered by the agent on line; c) must be provided by the user.
```

Save the spec to `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\4bfd128d-ecbb-4e7a-ace5-d33916834042/spec.md`.

### [ ] Step: Implementation Plan

Based on the technical spec in `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\4bfd128d-ecbb-4e7a-ace5-d33916834042/spec.md`, create a detailed task plan and update `c:\Users\Al Baraa\Desktop\Github Project\AUTOHIVE\.zencoder\chats\4bfd128d-ecbb-4e7a-ace5-d33916834042/plan.md`. Each task should have task definition, references to contracts to be used/implemented, deliverable definition and verification instructions.

---

## Implementation Tasks

### [x] Phase 1.1: Add User Reviews Relationship to User Model

**Task Description**:
Add a `reviews()` relationship to the User model to fetch all reviews written by a user.

**Contracts**:
- User model relationship: `reviews()` → hasMany(Review::class, 'user_id')
- Add computed accessor: `average_rating` returning AVG(rating) from user's reviews

**Deliverable**:
- Updated `app/Models/User.php` with reviews relationship and average_rating accessor

**Verification**:
```bash
# In tinker or test
$user = User::with('reviews')->find(1);
echo $user->average_rating; // Should return float or null

# Check query doesn't produce N+1
# Test file: tests/Feature/UserModelTest.php
```

---

### [x] Phase 1.2: Enhance RentalApplicationController::show() Method

**Task Description**:
Update the `show()` method to eager load tenant reviews when returning application detail.

**Contracts**:
- Endpoint: `GET /api/rental-applications/{id}`
- Response includes: `user.reviews` (array), `user.average_rating` (float)
- Load: `user.reviews.apartment` for context

**Deliverable**:
- Modified `app/Http/Controllers/Api/RentalApplicationController.php` show() method
- Returns enhanced application with review data

**Verification**:
```bash
# Test with Postman/API testing
GET /api/rental-applications/1
Authorization: Bearer {token}

# Verify response has:
# - data.user.average_rating (number or null)
# - data.user.reviews (array with id, rating, comment, apartment)

# Test file: tests/Feature/RentalApplicationControllerTest.php::testShowIncludesUserReviews
```

---

### [x] Phase 1.3: Enhance RentalApplicationController::incoming() Method

**Task Description**:
Update the `incoming()` method to include tenant reviews for all incoming applications.

**Contracts**:
- Endpoint: `GET /api/rental-applications/incoming`
- Response: Array of applications, each with `user.reviews` and `user.average_rating`
- Same structure as show() for consistency

**Deliverable**:
- Modified `app/Http/Controllers/Api/RentalApplicationController.php` incoming() method
- Eager loads reviews for all returned applications

**Verification**:
```bash
# Test with Postman
GET /api/rental-applications/incoming
Authorization: Bearer {landlord-token}

# Verify each application includes user.reviews and user.average_rating
# Check for N+1 by counting database queries

# Test file: tests/Feature/RentalApplicationControllerTest.php::testIncomingIncludesUserReviews
```

---

### [x] Phase 2.1: Create Tenant Review Card Widget

**Task Description**:
Create a new Flutter widget to display a single review card with rating, comment, and apartment context.

**Contracts**:
- Widget: `TenantReviewCard`
- Input: Review data (id, rating, comment, created_at, apartment.title)
- Display: Star rating, comment text, apartment name, date

**Deliverable**:
- New file: `lib/presentation/widgets/tenant_review_card.dart`
- Reusable widget for displaying reviews

**Verification**:
```bash
# Widget test
flutter test test/presentation/widgets/tenant_review_card_test.dart

# Test scenarios:
# - Renders 5-star rating correctly
# - Renders comment text
# - Displays apartment name
# - Formats date correctly
# - Handles long comments (ellipsis)
```

---

### [x] Phase 2.2: Create Tenant Rating Summary Widget

**Task Description**:
Create a widget to display tenant's average rating and review count as a summary section.

**Contracts**:
- Widget: `TenantRatingSummary`
- Input: average_rating (double), review_count (int)
- Display: Star rating (visual), average as text (4.5/5.0), count (12 reviews)

**Deliverable**:
- New file: `lib/presentation/widgets/tenant_rating_summary.dart`
- Shows overall rating summary

**Verification**:
```bash
# Widget test
flutter test test/presentation/widgets/tenant_rating_summary_test.dart

# Test scenarios:
# - Displays 4.5 stars correctly
# - Shows review count
# - Handles 0 reviews (displays "No reviews yet")
# - Responsive on different screen sizes
```

---

### [x] Phase 2.3: Enhance Rental Application Detail Screen

**Task Description**:
Update the landlord rental application detail screen to display tenant reviews section below profile.

**Contracts**:
- File: `lib/presentation/screens/landlord/rental_application_detail.dart`
- Location: After tenant profile card, before application actions
- Content: Rating summary + recent reviews list

**Deliverable**:
- Updated rental application detail screen with reviews section
- Includes both widgets created in Phase 2.1 and 2.2

**Verification**:
```bash
# Integration test
flutter test test/presentation/screens/landlord/rental_application_detail_test.dart

# Test scenarios:
# - Reviews section displays for tenant with reviews
# - "No reviews yet" shown for new tenant
# - Reviews load from API correctly
# - Screen renders without overflow on multiple sizes
# - Riverpod state management works correctly
```

---

### [x] Phase 2.4: Enhance Tenant Profile Card Widget

**Task Description**:
Update existing `TenantProfileCard` to optionally display average rating and review count.

**Contracts**:
- File: `lib/presentation/widgets/tenant_profile_card.dart`
- Add optional parameter: `showRating` (bool, default true)
- Include small rating badge if rating available

**Deliverable**:
- Updated tenant profile card with rating information
- Maintains backward compatibility

**Verification**:
```bash
# Widget test - verify existing tests still pass
# Verify rating badge displays when available
# Verify "showRating=false" hides rating
```

---

### [x] Phase 3.1: Enhance Modification Review Screen

**Task Description**:
Update the modification review screen (shown to landlord) to display tenant information with reviews.

**Contracts**:
- File: `lib/presentation/screens/shared/modification_review_screen.dart`
- Content: Tenant profile card + rating summary + modification diff
- Layout: Profile on top, diff in middle, actions at bottom

**Deliverable**:
- Updated modification review screen with enhanced tenant visibility

**Verification**:
```bash
# Visual test - open screen with pending modification
# Verify tenant info and reviews display correctly
# Verify diff view still shows changes clearly
# Check UI doesn't break on different screen sizes
```

---

### [x] Phase 3.2: Add Review Count to Incoming Applications List

**Task Description**:
Add visual indicator (badge) showing tenant's review count on incoming applications list cards.

**Contracts**:
- File: `lib/presentation/screens/landlord/incoming_rental_applications.dart`
- Display: Small badge with rating and count (e.g., "★ 4.5 (12 reviews)")
- Position: Top-right of card or after tenant name

**Deliverable**:
- Updated incoming applications screen with rating badges

**Verification**:
```bash
# Visual verification
# - Badges display on all cards
# - Rating and count are visible
# - No overflow or layout issues
# - Badge styling matches design
```

---

### [x] Phase 4.1: Create Integration Test for Full Workflow

**Task Description**:
Write comprehensive test covering the complete rental application review flow with tenant profile/reviews.

**Contracts**:
- Test file: `tests/Feature/RentalApplicationReviewWorkflowTest.php`
- Steps:
  1. Create tenant user with 3+ completed reviews
  2. Tenant submits rental application
  3. Landlord fetches incoming applications
  4. Landlord opens application detail
  5. Verify reviews are displayed correctly
  6. Landlord approves application

**Deliverable**:
- Comprehensive integration test

**Verification**:
```bash
php artisan test tests/Feature/RentalApplicationReviewWorkflowTest.php

# Should pass all steps and verify:
# - Reviews loaded correctly
# - Average rating calculated correctly
# - No N+1 queries
# - Proper authorization
```

---

### [x] Phase 4.2: Performance and Polish

**Task Description**:
Optimize queries, handle edge cases, and finalize UI polish.

**Tasks**:
- Verify no N+1 queries in application list endpoints
- Handle reviews with very long comments (truncate/ellipsis)
- Test with tenants having 0 reviews, 1 review, 50+ reviews
- Verify responsive design on phone/tablet/desktop
- Add proper error handling for review loading failures
- Update API documentation

**Deliverable**:
- Production-ready feature with all edge cases handled

**Verification**:
```bash
# Run full test suite
php artisan test

# Check database queries with Laravel Debugbar
# Visual test on multiple devices
# Check code follows PSR-12 standards
php artisan lint:fix
```

---

### [x] Phase 4.3: Testing & QA Approval

**Task Description**:
Final verification of all requirements from PRD.

**Verification Checklist**:
- ✅ Landlord can view tenant profile in application detail
- ✅ Tenant reviews displayed with rating and comment
- ✅ Average rating shown correctly
- ✅ "No reviews yet" message for new tenants
- ✅ Modification review screen shows tenant reviews
- ✅ Incoming applications list shows rating badges
- ✅ All screens responsive
- ✅ No console errors or warnings
- ✅ All tests passing
- ✅ No N+1 queries
- ✅ Performance acceptable (&lt;200ms load time)

**Deliverable**:
- Feature marked as complete and production-ready

---
